name: makemkv
summary: Backup your Bluray and DVD discs
description: |
  Backup your Bluray and DVD discs
grade: stable
confinement: strict
adopt-info: makemkv-oss
base: core24
compression: lzo

platforms:
  amd64:
    build-on: [amd64]
    build-for: [amd64]
  arm64:
    build-on: [arm64]
    build-for: [arm64]

hooks:
  install:
    command-chain: [bin/desktop-launch]
    environment:
      LD_LIBRARY_PATH: $SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET:$SNAP/usr/lib:$SNAP/lib/$SNAPCRAFT_ARCH_TRIPLET:$SNAP/lib
  post-refresh:
    command-chain: [bin/desktop-launch]
    environment:
      LD_LIBRARY_PATH: $SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET:$SNAP/usr/lib:$SNAP/lib/$SNAPCRAFT_ARCH_TRIPLET:$SNAP/lib
apps:
  makemkv:
    command: usr/bin/makemkv
    extensions:
      - kde-neon
    command-chain:
      - bin/desktop-launch
      - bin/makemkv-launch
    desktop: usr/share/applications/makemkv.desktop
    plugs:
      - gsettings
      - hardware-observe
      - home
      - network
      - opengl
      - optical-drive
      - optical-write
      - process-control
      - removable-media
      - desktop

  makemkvcon:
    command: usr/bin/makemkvcon
    command-chain:
      - bin/makemkv-launch
    environment:
      LD_LIBRARY_PATH: $SNAP/usr/lib:$SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET:$SNAP/lib:$SNAP/lib/$SNAPCRAFT_ARCH_TRIPLET
    plugs:
      - hardware-observe
      - home
      - network
      - optical-drive
      - optical-write
      - process-control
      - removable-media
parts:
  scripts:
    source: scripts
    plugin: dump
    organize:
      makemkv-launch: bin/makemkv-launch
    stage-packages:
      - rsync

  makemkv-oss:
    plugin: autotools
    build-packages:
      - curl
      - libcurl4-openssl-dev
      - libexpat1-dev
      - libegl1-mesa-dev
      - libgl1-mesa-dev
      - libssl-dev
      - libc6-dev
      - libavcodec-dev
      - qtbase5-dev
      - tar
      - zlib1g-dev
      - libglx-mesa0
    build-snaps:
      - ffmpeg-2404
      
    source: https://www.makemkv.com/download/makemkv-oss-1.18.2.tar.gz
    override-pull: |
      craftctl default
      VERSION="1.18.2"
      echo "Setting snap version to '$VERSION'"
      craftctl set version="$VERSION"
      echo "$VERSION" > "$SNAPCRAFT_PROJECT_DIR/version"
      patch -Np1 -i "$SNAPCRAFT_PROJECT_DIR/patches/patch.diff"
    override-build: |
      sed -i 's|Icon=.*|Icon=/usr/share/icons/hicolor/256x256/apps/makemkv.png|' makemkvgui/share/makemkv.desktop
      craftctl default
    autotools-configure-parameters:
      - --prefix=/usr
    stage-packages:
      - libcurl4
      - libegl1-mesa-dev
      - libexpat1
      - libglx-mesa0
      - libgles2-mesa-dev
    stage-snaps:
      - ffmpeg-2404
