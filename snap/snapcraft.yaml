name: makemkv
summary: Backup your Bluray and DVD discs
description: |
  Backup your Bluray and DVD discs
grade: stable
confinement: strict
adopt-info: makemkv-oss
base: core24
compression: lzo
icon: snap/gui/makemkv.png

platforms:
  amd64:
    build-on: [amd64]
    build-for: [amd64]
    
apps:
  makemkv:
    command: usr/bin/makemkv
    extensions:
      - kde-neon
    desktop: usr/share/applications/makemkv.desktop
    plugs:
      - gsettings
      - hardware-observe
      - home
      - network
      - opengl
      - process-control
      - removable-media
      - desktop
  
  makemkvcon:
    command: usr/bin/makemkvcon 
    plugs:
      - hardware-observe
      - home
      - network
      - process-control
      - removable-media         

parts:
  makemkv-oss:
    source: https://www.makemkv.com/download/makemkv-oss-1.18.2.tar.gz
    source-type: tar
    plugin: nil
    override-build: |
      cd makemkv-oss-1.18.2/
      ./configure
      make
      make install
      
    build-packages:
      - build-essential 
      - pkg-config
      - libc6-dev 
      - libssl-dev 
      - libexpat1-dev 
      - libavcodec-dev 
      - libgl1-mesa-dev 
      - qtbase5-dev 
      - zlib1g-dev
      - curl

    override-pull: |
      VERSION="$(curl --silent --show-error --location \
        'https://www.makemkv.com/forum/viewtopic.php?f=3&t=224' \
        | grep -E 'https?://www.makemkv.com/download/makemkv-bin-[0-9]+\.[0-9]+\.[0-9]+\.tar\.gz' \
        | head -n1 | sed -E -e \
          's|^.*\"https?://www.makemkv.com/download/makemkv-bin-([0-9]+\.[0-9]+\.[0-9]+)\.tar\.gz\".*|\1|')"
      echo "Setting snap version to '$VERSION'"
      craftctl set version="$VERSION"
      echo "$VERSION" > "$SNAPCRAFT_PROJECT_DIR/version"

    stage-packages:
      - libegl1-mesa-dev
      - libexpat1
      - libglx-mesa0
      - libgles2-mesa-dev
      - ffmpeg
      - libavutil-dev
      
  makemkv-bin:
    after: [makemkv-oss]
    plugin: nil
    source: https://www.makemkv.com/download/makemkv-bin-1.18.2.tar.gz
    source-type: tar 
    override-build:
      cd makemkv-bin-1.18.2/
      ./configure
      make
      make install
           
    build-packages:
      - build-essential 
      - pkg-config
      - libc6-dev 
      - libssl-dev 
      - libexpat1-dev 
      - libavcodec-dev 
      - libgl1-mesa-dev 
      - qtbase5-dev 
      - zlib1g-dev
 
    stage-packages:
      - libavutil-dev
      - ffmpeg
      - libavcodec-dev                      
